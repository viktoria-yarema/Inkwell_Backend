# name: Deploy to Cloud Run

# on:
#   push:
#     branches: [main, master]
#   pull_request:
#     branches: [main, master]

# env:
#   PROJECT_ID: inkwell-447220
#   SERVICE_NAME: inkwell-dev
#   REGION: europe-west10

# jobs:
#   deploy:
#     name: Deploy to Cloud Run
#     runs-on: ubuntu-latest

#     # Only deploy on pushes to main/master, not on PRs
#     if: github.event_name == 'push'

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Set up Google Cloud SDK
#         uses: google-github-actions/setup-gcloud@v1
#         with:
#           project_id: ${{ env.PROJECT_ID }}
#           service_account_key: ${{ secrets.GCP_SA_KEY }}
#           export_default_credentials: true

#       - name: Configure Docker for GCR
#         run: gcloud auth configure-docker

#       - name: Build Docker image
#         run: |
#           docker build -t gcr.io/$PROJECT_ID/$SERVICE_NAME:latest .
#           docker tag gcr.io/$PROJECT_ID/$SERVICE_NAME:latest gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA

#       - name: Push to Google Container Registry
#         run: |
#           docker push gcr.io/$PROJECT_ID/$SERVICE_NAME:latest
#           docker push gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA

#       - name: Deploy to Cloud Run
#         run: |
#           gcloud run deploy $SERVICE_NAME \
#             --image gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA \
#             --platform managed \
#             --region $REGION \
#             --allow-unauthenticated \
#             --memory 512Mi \
#             --cpu 1000m \
#             --max-instances 10 \
#             --min-instances 0 \
#             --port 8080 \
#             --timeout 300s \
#             --concurrency 80 \
#             --service-account="inkwell-bucket@$PROJECT_ID.iam.gserviceaccount.com" \
#             --quiet

#       - name: Get service URL
#         run: |
#           SERVICE_URL=$(gcloud run services describe $SERVICE_NAME --region=$REGION --format="value(status.url)")
#           echo "Service deployed at: $SERVICE_URL"
#           echo "Health check: $SERVICE_URL/health"
